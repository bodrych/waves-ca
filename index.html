<!DOCTYPE html>
<html>
<head>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
	<script src="https://unpkg.com/base-58@0.0.1/Base58.js"></script>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAABFvgAARb4B0IHyYgAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAIpSURBVHic5du5edtAFEXhM66HqM/OBGVWexz2ohBO/PhJFJZZ3oLlNkCcP5BIYACByzmPj8fjb+Q1pKgPzjmPwBtASunjdrv9ibiOEICv8c8LCUJwB5iLl0UguAKsxcu8EdwASuJlngguADXxMi8Ec4CWeJkHgilAT7zMGsEMQCNeZolgAqAZL7NCUAewiJdZIKgCWMbLtBHUADziZZoIKgCe8TIthG6AiHiZBkIXQGS8rBehGWAP8bIehCaAPcXLWhGqAfYYL2tBqALYc7ysFqEY4AjxshqEIoAjxctKETYBjhgvK0FYBThyvGwLYRHgDPGyNYRZgDPFy5YQfgCcMV42h/AN4MzxsleEJ8AV4mVfERJcK14mCOmK8bKU0sevaZo+oy8katM0fSaA+/3+O6UUelAhYOMwDO/PP4IXQxiHYXiHl3+DF0F4xsPMF6GTI3yLh4WvwidF+BEPKz+GToYwGw8bP4dPgrAYDwU3RA6OsBoPhbfEDoqwGQ8VN0UPhlAUD5W3xQ+CUBwPDQ9Gdo5QFQ+Nj8Z2ilAdDx0PR3eG0BQPnY/Hd4LQHA8KBySCEbriQemITBBCdzwoHpJyRlCJB+Vjck4IavFgcFDSGEE1HoyOyhohqMeD4WFpZQSTeDA+Lq+EYBYPDi9MdCKYxoPTKzONCObx4PjSVCWCSzw4vzZXiOAWDwEvTm4guMZD0KuzCwju8RD48vQLQkh8+HLO4//zCWH7B6TVRCpVqUZ2AAAAAElFTkSuQmCC" />
	<title>Waves CA</title>
	<style>
	body {
		font-family: Consolas, monospace;
		font-size: 14px;
	}
	.bordered {
		border: 1px solid lightgray;
		border-radius:5px;
		padding: 10px;
	}
	input, select {
		font-family: inherit;
		font-size: inherit;
	}
	select, input[type=text], input[type=number], input[type=checkbox] {
		border: 1px solid lightgray;
	}
	#app {
		display: flex;
	}
	#header > div {
		padding: 5px;
	}
	#params-first > div, #params-second > div, #params-third > div {
		align-items: center;
		padding: 5px;
	}
	#result, #input-data {
		padding: 5px;
		overflow-x: auto;
		border: 1px solid lightgray;
		margin: 5px 0px 0px 0px;
		max-width: 90vw;
	}
	#result-wrapper, #input-data-wrapper {
		margin: 5px;
	}
	#result-data-wrapper {
		align-items:initial;
	}
	#footer {
		padding: 5px;
	}
	.flex-row {
		display: flex;
		flex-direction: row;
		align-items: center;
		flex-wrap: wrap;
	}
	.flex-col {
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}
	label {
		margin: 0px 5px 0px 0px;
	}
	input, select {
		margin: 10px;
		padding: 5px;
	}
	.button {
		background-color: white;
		color: black;
		border: 1px solid lightgray;
		transition-duration: 0.4s;
	}
	.button:hover {
		background-color: lightgray;
	}
	.load {
		width: 50px;
	}
	.submit {
		width: 200px;
	}
	table {
		margin: 10px;
    border-collapse: collapse;
    /*width: 100%;*/
	}
	td, th {
    border: 1px solid lightgray;
    padding: 10px;
    max-width: 300px;
    overflow: auto;
    white-space: nowrap;
	}
	tr:hover {
		background-color: lightgray;
	}
	#edit-cert, #cert-list {
		margin: 10px;
	}
	#admin {
		align-items: flex-start;
	}
</style>
</head>
<body>
	<div id="app" class="flex-col">
		<div id="header" class="flex-row">
			<div>
				<label>Mode:</label>
				<select v-model="mode">
					<option value="user">user</option>
					<option value="admin">admin</option>
				</select>
			</div>
		</div>
		<div id="check-cert" class="flex-col bordered">
			Check certificate
			<div class="flex-row">
				<label>Type:</label>
				<select v-model="check.type">
					<option value="ID">ID</option>
					<option value="PK">PK</option>
				</select>
				<label>Data:</label>
				<input v-model="check.data" type="text" name="">
				<input class="submit button" type="submit" value="Check" @click="checkCert">
			</div>
			<div class="flex-row bordered">
				{{ check.result }}
			</div>
		</div>
		<div id="admin" class="flex-row" v-if="mode == 'admin'">
			<div id="edit-cert" class="flex-col bordered">
				Certificate edit
				<div>
					<label>ID</label>
					<input v-model="cert.id" type="number" name="">
				</div>
				<div>
					<label>PK</label>
					<input v-model="cert.owner" type="text" name="">
				</div>
				<div>
					<label>Status</label>
					<select :value="cert.status" @input="$event.target.value == 'true' ? cert.status = true : cert.status = false">
						<option value="true">true</option>
						<option value="false">false</option>
					</select>
				</div>
				<div>
					<label>Hash</label>
					<input v-model="cert.hash" type="text" name="">
				</div>
				<input class="submit button" type="submit" value="Send" @click="addCert">
			</div>
			<div id="cert-list" class="flex-col bordered">
				<label>Certificates list</label>
				<input class="submit button" type="submit" value="Update" @click="getCerts">
				<table>
					<tr>
						<td>ID</td>
						<td>Owner's PK</td>
						<td>Status</td>
						<td>Hash</td>
					</tr>
					<tr v-for="(item, index) in certs" @click="editCert(index)">
						<td>{{ item.id }}</td>
						<td>{{ item.owner }}</td>
						<td>{{ item.status }}</td>
						<td>{{ item.hash }}</td>
					</tr>
				</table>
			</div>
		</div>
		<div id="footer" class="flex-col">
			<a href="https://github.com/bodrych/waves-ca">GitHub</a>
			<a href="https://forum.wavesplatform.com/t/waves-keeper-beta/3547">Waves Keeper</a>
			<a :href="'https://testnet.wavesexplorer.com/address/' + CA">CA: {{ CA }}</a>
		</div>
	</div>
	<script>
		var app = new Vue({
			el: '#app',
			data: {
				// node: 'https://nodes.wavesplatform.com',
				node: 'https://testnode1.wavesnodes.com',
				CA: '3NBZsCMvJkSDUtVSdYA8mCMn1bwv7fa7zo2',
				CAPK: '2vet7Phh3JLvc5xRknLoT6YbBsnyU98LywPsER6ixStk',
				result: '',
				mode: 'user',
				cert: {
					id: 0,
					owner: '',
					hash: '',
					status: true
				},
				check: {
					type: 'ID',
					data: '',
					result: false
				},
				certs: []
			},
			created: function() {
				setTimeout(() => {
					if (!this.checkKeeper()) {
						alert('Please, install Waves Keeper');
					}
				}, 1000);
			},
			methods: {
				checkKeeper: function() {
					return typeof window.Waves !== 'undefined';
				},
				editCert: function(i) {
					this.cert.id = this.certs[i].id;
					this.cert.owner = this.certs[i].owner;
					this.cert.hash = this.certs[i].hash;
					this.cert.status = this.certs[i].status;
				},
				getData: async function() {
					let rawData = await fetch(this.node + '/addresses/data/' + this.CA);
					let data = await rawData.json();
					return data;
				},
				getCerts: async function() {
					let data = await this.getData();
					let filtered = data.filter(item => {
						if (Number(item.key) > 0) {
							return true;
						} else {
							return false;
						}
					});
					let certs = filtered.map(item => {
						let status = this.findByKey(data, item.key + '.status');
						status = status ? status.value : '';
						let hash = this.findByKey(data, item.key + '.hash');
						hash = hash ? hash.value : '';
						return {
							id: item.key,
							owner: item.value,
							status: status,
							hash: hash
						};
					});
					this.certs = certs;
					return certs;
				},
				addCert: async function() {
					let data = {
						fee: {
							assetId: 'WAVES',
							tokens: '0.005'
						},
						data: [
							{type: 'string', key: this.cert.id, value: this.cert.owner},
							{type: 'string', key: this.cert.owner, value: this.cert.id},
							{type: 'binary', key: this.cert.id + '.hash', value: this.cert.hash},
							{type: 'boolean', key: this.cert.id + '.status', value: this.cert.status}
						],
						senderPublicKey: this.CAPK
					}
					await this.signAndPublishTx(data);
				},
				findByKey: function(array, id) {
					let element = array.find(element => {
						return element.key == id ? element : false;
					});
					return element;
				},
				checkCert: async function() {
					let certs = await this.getData();
					let id = '';
					switch (this.check.type) {
						case 'ID':
							id = this.check.data;
							break;
						case 'PK':
							let data = await this.findByKey(certs, this.check.data);
							id = data.value;
							break;
						default:
							id = this.check.data;
							break;
					}
					let status = await this.findByKey(certs, id + '.status');
					let result;
					if (status) {
						result = status.value;
					} else {
						result = false;
					}
					this.check.result = result;
					return result;
				},
				signAndPublishTx: async function(data) {
					let params = {
						type: 12,
						data: data
					}
					try {
						let res = await window.Waves.signAndPublishTransaction(params);
						this.result = res;
						console.log(res);
					} catch (err) {
						alert(err.message);
						console.log(err);
					}
				}
			}
		});
	</script>
</body>
</html>